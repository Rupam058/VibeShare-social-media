<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
    </head>
    <style>
        body {
            background-color: #221a1a;
            padding: 2rem;
            color: white;
        }
        a {
            color: white;
        }
    </style>
    <body>
        <input type="file" id="postImage" accept="image/png, image/jpg" />
        <button onclick="create()">Create Post</button>
        <button onclick="setAvatar()">Set Avatar</button>
        <br /><br />

        <button onclick="register()">Register</button>
        <button onclick="login()">Login</button>
        <button onclick="logout()">Logout</button>
        <a href="http://localhost:8000/auth/redirect/google"
            >Login with Google</a
        >

        <div id="posts"></div>

        <script>
            // const API_BASE_URL = "https://social-media.test";
            const API_BASE_URL = "http://localhost:8000";

            function xsrfToken() {
                const xsrfToken = document.cookie
                    .split("; ")
                    .find((row) => row.startsWith("XSRF-TOKEN="))
                    ?.split("=")[1];
                return xsrfToken;
            }
            async function getCsrfResponse() {
                try {
                    const csrfResponse = await fetch(
                        `${API_BASE_URL}/sanctum/csrf-cookie`,
                        {
                            method: "GET",
                            credentials: "include",
                            headers: {
                                Accept: "application/json",
                            },
                        },
                    );

                    console.log("CSRF Response", csrfResponse);
                } catch (error) {
                    console.log("error:", error);
                }
            }

            window.addEventListener("load", renderPosts);

            function getFile() {
                const postImageElement = document.getElementById("postImage");
                if (postImageElement == null) return null;

                if (postImageElement.files.length != 1) return null;

                return postImageElement.files[0];
            }

            async function create() {
                try {
                    let image = getFile();
                    if (image == null) {
                        console.log("No image selected");
                        return;
                    }

                    const formData = new FormData();
                    formData.append("caption", "testing image");
                    formData.append("image", image);

                    await getCsrfResponse();
                    const getCooked = decodeURIComponent(xsrfToken());

                    const postResponse = await fetch(
                        `${API_BASE_URL}/api/posts`,
                        {
                            method: "POST",
                            credentials: "include",
                            headers: {
                                "X-XSRF-TOKEN": getCooked,
                                Accept: "application/json",
                            },
                            body: formData,
                        },
                    );

                    console.log("Post Response", await postResponse.json());
                } catch (error) {
                    console.log("error:", error);
                }
            }

            async function setAvatar() {
                try {
                    let image = getFile();
                    if (image == null) return;

                    const formData = new FormData();
                    formData.append("image", image);

                    await getCsrfResponse();
                    const getCooked = decodeURIComponent(xsrfToken());

                    const avatarResponse = await fetch(
                        `${API_BASE_URL}/api/user/avatar`,
                        {
                            method: "POST",
                            credentials: "include",
                            body: formData,
                            headers: {
                                Accept: "application/json",
                                "X-XSRF-TOKEN": getCooked,
                            },
                        },
                    );
                    console.log("Avatar Response", await avatarResponse.json());
                } catch (error) {
                    console.log("error in setting Avatar:", error);
                }
            }

            async function renderPosts() {
                await getCsrfResponse();

                const registerResponse = await fetch(
                    `${API_BASE_URL}/api/posts`,
                    {
                        method: "GET",
                        credentials: "include",
                    },
                );
                const posts = await registerResponse.json();

                for (let post of posts) {
                    document.getElementById("posts").innerHTML +=
                        `<h3>${post.caption}</h3><img style="width: 600px" src="${API_BASE_URL}/storage/uploads/${post.image}"><br>`;
                }
            }

            async function register() {
                try {
                    await getCsrfResponse();
                    const getCooked = decodeURIComponent(xsrfToken());

                    const registerResponse = await fetch(
                        `${API_BASE_URL}/auth/register`,
                        {
                            method: "POST",
                            credentials: "include",
                            headers: {
                                "Content-Type": "application/json",
                                "X-XSRF-TOKEN": getCooked,
                                Accept: "application/json",
                            },
                            body: JSON.stringify({
                                email: "somethingnothing058@gmail.com",
                                password: "StrongPassword",
                            }),
                        },
                    );

                    console.log("Register", await registerResponse.json());
                } catch (error) {
                    console.log("error:", error);
                }
            }

            async function login() {
                try {
                    await getCsrfResponse();
                    const getCooked = decodeURIComponent(xsrfToken());

                    const registerResponse = await fetch(
                        `${API_BASE_URL}/auth/login`,
                        {
                            method: "POST",
                            credentials: "include",
                            headers: {
                                "Content-Type": "application/json",
                                "X-XSRF-TOKEN": getCooked,
                                Accept: "application/json",
                            },
                            body: JSON.stringify({
                                email: "test234@gmail.com",
                                password: "StrongPassword",
                            }),
                        },
                    );

                    console.log("Register", await registerResponse.json());
                } catch (error) {
                    console.log("error:", error);
                }
            }

            async function logout() {
                try {
                    await getCsrfResponse();
                    const getCooked = decodeURIComponent(xsrfToken());

                    const registerResponse = await fetch(
                        `${API_BASE_URL}/auth/logout`,
                        {
                            method: "POST",
                            credentials: "include",
                            headers: {
                                "Content-Type": "application/json",
                                "X-XSRF-TOKEN": getCooked,
                                Accept: "application/json",
                            },
                            body: JSON.stringify({
                                email: "test234@gmail.com",
                                password: "StrongPassword",
                            }),
                        },
                    );

                    console.log("Register", await registerResponse.json());
                } catch (error) {
                    console.log("error:", error);
                }
            }
        </script>
    </body>
</html>
